#**
@author Marvin Kickuth
*#
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8">
    <title>mthesis map</title>
    <link rel="shortcut icon" type="image/png" href="img/favicon.png"/>
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
    <link rel="stylesheet" type="text/css" href="css/map.css" />
</head>
<body>

<div class="sidenav">
    <form id="panelForm">
        <select id="algo" name="algo">
            <option value="ng">naive</option>
            <option value="gr">greedy</option>
            <option value="ot">other</option>
        </select>
        <label for="algo">algorithm</label>
        <br><br>
        max distance: <br>
        <label id="max_dist_km">$solver.getMaxDistanceKM()</label> km<br>  ## TODO update max_dist_km
        <input id="max_dist_factor" onchange="updateMaxDist()" type="number" step="0.01" min="1" style="width: 35%;" name="max_dist" value="$solver.getMaxDistanceFactor()">
        <label for="max_dist"> SP factor</label><br><br>
        <label>
            <input type="number" min="0" style="width: 35%;" name="source" value="$solver.getSource().getId()">
            Source ID
        </label>
        <label>
            <input type="number" min="0" style="width: 35%;" name="sink" value="$solver.getTarget().getId()">
            Sink ID
        </label><br><br>
        <button class="button" id="submitButton"><span>Go!</span></button><br><br><br> ## TODO fix awful layout
    </form>

    <progress id="progressBar" value="0" max="100" style="width: 95%; margin: 0 auto;"></progress>

    <input type="checkbox" id="poiToggle" onchange="togglePois(this)" checked/><label for="poiToggle">Show POIs</label>
</div>

<div class="main" style="width: 100%; height: 95vh; top: 0; left: 0" id="map"></div>

<!-- Add the Leaflet JavaScript library and plugins -->
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.AnimatedMarker/1.0.0/AnimatedMarker.js"></script>
<!-- Add jquery library and plugins -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.2.2/jquery.form.min.js"></script>

<script>
    // Create variable to hold map element, give initial settings to map
    var map = L.map('map',{ center: [48, 9.5], zoom: 10});
    // Add OpenStreetMap tile layer to map
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', { attribution: 'OpenStreetMap', opacity: 0.7 }).addTo(map);


    // Paths
    const colors = ['#f00', '#0f0', '#00f', '#f70', '#000'];
    let col_idx = 0;
    const lineStyle = {
        "color": colors[col_idx],
        "weight": 5,
        "opacity": 0.75
    };


    // POIs
    const canvasRenderer = L.canvas({ padding: 0.5 });  ## renderer that draws everything onto a single canvas

    var poiLayer = L.geoJSON($poiGeoJSON, {
        renderer: canvasRenderer,
        onEachFeature: function (feature, layer) {
            layer.bindPopup(feature.properties.name + " - " + feature.properties.id);
        },
        pointToLayer: function (feature, latlon) {
            let name = feature.properties.name;
            return L.circleMarker(latlon, {
                radius: 6,
                fillColor: colors[name.charCodeAt(name.length-1) % colors.length],
                color: '#000',
                weight: 1,
                opacity: 0.5,
                fillOpacity: 0.7
            });
        }
    }).addTo(map);

    // shortest path between source and target, i.e. allowed max dist ignoring factor.
    var baseMaxDist = $solver.getMaxDistance();

    // Toggle: Display/hide POIs
    function togglePois(obj) {
        if (obj.checked) {
            map.addLayer(poiLayer);
        } else {
            map.removeLayer(poiLayer);
        }
    }

    // Define submit behaviour
    $('#panelForm').on('submit', function computePath() {
        document.getElementById("submitButton").disabled = true;
        const progressUpdater = window.setInterval(function () {
            $.getJSON("status", function (res) {
                document.getElementById("progressBar").value = res.progress;
            });
        }, 1000);

        $('#panelForm').ajaxSubmit("path", null, "json", function (res) {
            L.geoJSON(res, {style: lineStyle}).bindPopup("score: " + res.score + " length: " + res.length).addTo(map);
            // var animatedMarker = L.animatedMarker(line.getLatLngs(), {
            //     distance: 100, // meters
            //     interval: 50, // milliseconds
            // }).addTo(map);
            lineStyle.color = colors[++col_idx%colors.length];
            // update max distance
            baseMaxDist = parseInt(res.shortestpathdist);
            updateMaxDist();
            // stop updating and reset the progressbar
            window.clearInterval(progressUpdater);
            document.getElementById("progressBar").value = 0;
            document.getElementById("submitButton").disabled = false;
        });

        return false;  // do not reload page on submit
    });

    function updateMaxDist() {
        document.getElementById("max_dist_km").innerHTML = ((baseMaxDist * document.getElementById("max_dist_factor").value) | 0) / 1000;
    }
</script>
</body>
</html>
